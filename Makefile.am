ACLOCAL_AMFLAGS=-I m4

SUBDIRS = src lib Doc

## doxygen documentation
include $(top_srcdir)/Doc/doxygen.am

matrices_DATA=\
Data/Matrices/RIBOSUM85_60

#Data/Matrices/RIBOSUM100_25 Data/Matrices/RIBOSUM100_30	\
Data/Matrices/RIBOSUM100_35 Data/Matrices/RIBOSUM100_40	\
Data/Matrices/RIBOSUM100_45 Data/Matrices/RIBOSUM100_50	\
Data/Matrices/RIBOSUM100_55 Data/Matrices/RIBOSUM100_60	\
Data/Matrices/RIBOSUM100_65 Data/Matrices/RIBOSUM100_70	\
Data/Matrices/RIBOSUM100_75 Data/Matrices/RIBOSUM100_80	\
Data/Matrices/RIBOSUM100_85 Data/Matrices/RIBOSUM100_90	\
Data/Matrices/RIBOSUM100_95 Data/Matrices/RIBOSUM45_25	\
Data/Matrices/RIBOSUM45_30 Data/Matrices/RIBOSUM45_35	\
Data/Matrices/RIBOSUM45_40 Data/Matrices/RIBOSUM45_45	\
Data/Matrices/RIBOSUM45_50 Data/Matrices/RIBOSUM45_55	\
Data/Matrices/RIBOSUM45_60 Data/Matrices/RIBOSUM45_65	\
Data/Matrices/RIBOSUM45_70 Data/Matrices/RIBOSUM45_75	\
Data/Matrices/RIBOSUM45_80 Data/Matrices/RIBOSUM45_85	\
Data/Matrices/RIBOSUM45_90 Data/Matrices/RIBOSUM45_95	\
Data/Matrices/RIBOSUM50_25 Data/Matrices/RIBOSUM50_30	\
Data/Matrices/RIBOSUM50_35 Data/Matrices/RIBOSUM50_40	\
Data/Matrices/RIBOSUM50_45 Data/Matrices/RIBOSUM50_50	\
Data/Matrices/RIBOSUM50_55 Data/Matrices/RIBOSUM50_60	\
Data/Matrices/RIBOSUM50_65 Data/Matrices/RIBOSUM50_70	\
Data/Matrices/RIBOSUM50_75 Data/Matrices/RIBOSUM50_80	\
Data/Matrices/RIBOSUM50_85 Data/Matrices/RIBOSUM50_90	\
Data/Matrices/RIBOSUM50_95 Data/Matrices/RIBOSUM55_25	\
Data/Matrices/RIBOSUM55_30 Data/Matrices/RIBOSUM55_35	\
Data/Matrices/RIBOSUM55_40 Data/Matrices/RIBOSUM55_45	\
Data/Matrices/RIBOSUM55_50 Data/Matrices/RIBOSUM55_55	\
Data/Matrices/RIBOSUM55_60 Data/Matrices/RIBOSUM55_65	\
Data/Matrices/RIBOSUM55_70 Data/Matrices/RIBOSUM55_75	\
Data/Matrices/RIBOSUM55_80 Data/Matrices/RIBOSUM55_85	\
Data/Matrices/RIBOSUM55_90 Data/Matrices/RIBOSUM55_95	\
Data/Matrices/RIBOSUM60_25 Data/Matrices/RIBOSUM60_30	\
Data/Matrices/RIBOSUM60_35 Data/Matrices/RIBOSUM60_40	\
Data/Matrices/RIBOSUM60_45 Data/Matrices/RIBOSUM60_50	\
Data/Matrices/RIBOSUM60_55 Data/Matrices/RIBOSUM60_60	\
Data/Matrices/RIBOSUM60_65 Data/Matrices/RIBOSUM60_70	\
Data/Matrices/RIBOSUM60_75 Data/Matrices/RIBOSUM60_80	\
Data/Matrices/RIBOSUM60_85 Data/Matrices/RIBOSUM60_90	\
Data/Matrices/RIBOSUM60_95 Data/Matrices/RIBOSUM65_25	\
Data/Matrices/RIBOSUM65_30 Data/Matrices/RIBOSUM65_35	\
Data/Matrices/RIBOSUM65_40 Data/Matrices/RIBOSUM65_45	\
Data/Matrices/RIBOSUM65_50 Data/Matrices/RIBOSUM65_55	\
Data/Matrices/RIBOSUM65_60 Data/Matrices/RIBOSUM65_65	\
Data/Matrices/RIBOSUM65_70 Data/Matrices/RIBOSUM65_75	\
Data/Matrices/RIBOSUM65_80 Data/Matrices/RIBOSUM65_85	\
Data/Matrices/RIBOSUM65_90 Data/Matrices/RIBOSUM65_95	\
Data/Matrices/RIBOSUM70_25 Data/Matrices/RIBOSUM70_30	\
Data/Matrices/RIBOSUM70_35 Data/Matrices/RIBOSUM70_40	\
Data/Matrices/RIBOSUM70_45 Data/Matrices/RIBOSUM70_50	\
Data/Matrices/RIBOSUM70_55 Data/Matrices/RIBOSUM70_60	\
Data/Matrices/RIBOSUM70_65 Data/Matrices/RIBOSUM70_70	\
Data/Matrices/RIBOSUM70_75 Data/Matrices/RIBOSUM70_80	\
Data/Matrices/RIBOSUM70_85 Data/Matrices/RIBOSUM70_90	\
Data/Matrices/RIBOSUM70_95 Data/Matrices/RIBOSUM75_25	\
Data/Matrices/RIBOSUM75_30 Data/Matrices/RIBOSUM75_35	\
Data/Matrices/RIBOSUM75_40 Data/Matrices/RIBOSUM75_45	\
Data/Matrices/RIBOSUM75_50 Data/Matrices/RIBOSUM75_55	\
Data/Matrices/RIBOSUM75_60 Data/Matrices/RIBOSUM75_65	\
Data/Matrices/RIBOSUM75_70 Data/Matrices/RIBOSUM75_75	\
Data/Matrices/RIBOSUM75_80 Data/Matrices/RIBOSUM75_85	\
Data/Matrices/RIBOSUM75_90 Data/Matrices/RIBOSUM75_95	\
Data/Matrices/RIBOSUM80_25 Data/Matrices/RIBOSUM80_30	\
Data/Matrices/RIBOSUM80_35 Data/Matrices/RIBOSUM80_40	\
Data/Matrices/RIBOSUM80_45 Data/Matrices/RIBOSUM80_50	\
Data/Matrices/RIBOSUM80_55 Data/Matrices/RIBOSUM80_60	\
Data/Matrices/RIBOSUM80_65 Data/Matrices/RIBOSUM80_70	\
Data/Matrices/RIBOSUM80_75 Data/Matrices/RIBOSUM80_80	\
Data/Matrices/RIBOSUM80_85 Data/Matrices/RIBOSUM80_90	\
Data/Matrices/RIBOSUM80_95 Data/Matrices/RIBOSUM85_25	\
Data/Matrices/RIBOSUM85_30 Data/Matrices/RIBOSUM85_35	\
Data/Matrices/RIBOSUM85_40 Data/Matrices/RIBOSUM85_45	\
Data/Matrices/RIBOSUM85_50 Data/Matrices/RIBOSUM85_55	\
Data/Matrices/RIBOSUM85_60 Data/Matrices/RIBOSUM85_65	\
Data/Matrices/RIBOSUM85_70 Data/Matrices/RIBOSUM85_75	\
Data/Matrices/RIBOSUM85_80 Data/Matrices/RIBOSUM85_85	\
Data/Matrices/RIBOSUM85_90 Data/Matrices/RIBOSUM85_95	\
Data/Matrices/RIBOSUM90_25 Data/Matrices/RIBOSUM90_30	\
Data/Matrices/RIBOSUM90_35 Data/Matrices/RIBOSUM90_40	\
Data/Matrices/RIBOSUM90_45 Data/Matrices/RIBOSUM90_50	\
Data/Matrices/RIBOSUM90_55 Data/Matrices/RIBOSUM90_60	\
Data/Matrices/RIBOSUM90_65 Data/Matrices/RIBOSUM90_70	\
Data/Matrices/RIBOSUM90_75 Data/Matrices/RIBOSUM90_80	\
Data/Matrices/RIBOSUM90_85 Data/Matrices/RIBOSUM90_90	\
Data/Matrices/RIBOSUM90_95 Data/Matrices/RIBOSUM95_25	\
Data/Matrices/RIBOSUM95_30 Data/Matrices/RIBOSUM95_35	\
Data/Matrices/RIBOSUM95_40 Data/Matrices/RIBOSUM95_45	\
Data/Matrices/RIBOSUM95_50 Data/Matrices/RIBOSUM95_55	\
Data/Matrices/RIBOSUM95_60 Data/Matrices/RIBOSUM95_65	\
Data/Matrices/RIBOSUM95_70 Data/Matrices/RIBOSUM95_75	\
Data/Matrices/RIBOSUM95_80 Data/Matrices/RIBOSUM95_85	\
Data/Matrices/RIBOSUM95_90 Data/Matrices/RIBOSUM95_95

matricesdir=$(prefix)/share/locarna/Matrices

EXTRA_DIST= Data/Examples/archaea.fa Data/Examples/ferritin.fa		\
	Data/Examples/human.fa Data/Examples/mouse.fa			\
	Data/Examples/haca.snoRNA.fa					\
	Data/Examples/haca.snoRNA_anchor.bed				\
	Data/Examples/hammerhead_3.fa Data/Examples/gcvT.fa		\
	Data/Examples/SECIS_15.fa Data/Examples/SECIS_15_ref.aln	\
	Data/Examples/example.fa Data/Examples/short-example.cfg	\
	Data/Examples/example.cfg					\
	Data/Examples/example-w-constraints.fa				\
	Data/Examples/example-wo-anchors.fa				\
	Data/Examples/example-realign.aln				\
	Data/Examples/example-anchors.bed $(matrices_DATA)		\
	Doc/doxygen.cfg

gen-test-results:
	make -C src/Tests gen-test-results

########################################
# BURNIN
#
# stress test and benchmark mlocarna
# with default parameters on pairwise and multi-way alignments
#
# requires compalignp and scif in path
#
.PHONY: burnin burnin-eval burnin-summary

burnin: install burnin-bralibase.k2 burnin.k2-high_apsi burnin.k2-low_apsi burnin-bralibase.k10 burnin.k10 burnin-summary

burnin-bralibase.%: $(abs_srcdir)/Data/Bralibase2.1/%.tgz
	bbset=${@:burnin-bralibase.%=%} ;\
	inputdir=$(abs_builddir)/burnin/input ;\
	mkdir -p $$inputdir ;\
	cd $$inputdir; \
	if [ ! -d $$bbset ] ; then tar xzf $< ; fi

burnin-summary:
	@echo
	@echo "=================================================="
	@cat $(abs_builddir)/burnin/benchmark*.log | grep '#' | sed 's/^#/  /g'
	@echo "=================================================="
	@echo

burnin-clean:
	chmod +w -R $(abs_builddir)/burnin/input
	$(RM) -r $(abs_builddir)/burnin

burnin.%: Data/Bralibase2.1/instances.%
	@instances=$< ;\
	burnindir=$(abs_builddir)/burnin ;\
	bbdir=$(abs_builddir)/burnin/input;\
	blog=$$burnindir/${@:burnin.%=benchmark-%}.log ;\
	if [ ! -d "$$burnindir" ] ; then mkdir "$$burnindir"; fi ;\
	echo "# ===== $$(date) =====" | tee -a $$blog ;\
	echo "# VERSION $$($(prefix)/bin/mlocarna --version)" | tee -a $$blog ;\
	if git status > /dev/null ; then \
	  echo "# GIT $$(git log -1 | head -n1) $$(git symbolic-ref --short HEAD)" \
	    | tee -a $$blog ;\
	fi ;\
	cat $$instances \
	  | \time --format '# TIME %U SPACE %M' parallel "mkdir -p $$burnindir/{};\
	      printf \"\\n\\n====={}\\n\";\
	      $(prefix)/bin/mlocarna $$bbdir/{} --stockholm --tgtdir $$burnindir/{}" \
	    2>&1 | cat >>$$blog
	@make ${@:burnin.%=burnin-eval.%}

burnin-eval.%: Data/Bralibase2.1/instances.%
	@instances=$< ;\
	burnindir=$(abs_builddir)/burnin ;\
	bbdir=$(abs_builddir)/burnin/input;\
	blog=$$burnindir/${@:burnin-eval.%=benchmark-%.log} ;\
	spstab=$$burnindir/${@:burnin-eval.%=sps-%.tab} ;\
	scitab=$$burnindir/${@:burnin-eval.%=sci-%.tab} ;\
	echo "# SET ${@:burnin-eval.%=%}" | tee -a $$blog ;\
	echo "# INSTANCES $$(cat $$instances | wc -l)" | tee -a $$blog ;\
	cat $$instances \
	  | parallel "\
	    printf \"{}\\t\";\
	    $(prefix)/bin/aln2fa.pl $$burnindir/{}/results/result.aln \
              > $$burnindir/{}/results/result.fa;\
	    compalignp -r $$bbdir/{=s/.raw.fa/.ref.fa/=} \
	               -t $$burnindir/{}/results/result.fa \
	    "\
            > $$burnindir/sps.tab ;\
	awk <$$burnindir/sps.tab '\
	  { SUM+=$$2; N+=1 } \
	  END { print "# AVG_SPS", SUM/N }\
	  '\
	  | tee -a $$blog ;\
	cat $$instances \
	  | parallel "\
	    printf \"{}\\t\";\
	    scif $$burnindir/{}/results/result.fa \
	    "\
            > $$burnindir/sci.tab ;\
	awk <$$burnindir/sci.tab '\
	  { SUM+=$$2; N+=1 } \
	  END { print "# AVG_SCI", SUM/N }\
	  '\
	  | tee -a $$blog
